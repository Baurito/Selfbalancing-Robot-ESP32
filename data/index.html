<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<title>BeerBot v1.0</title>

		<link rel="stylesheet" type="text/css" href="style.css">
		<script src='nipplejs.min.js'></script>
		<script src='gauge.min.js'></script>
	</head>

	<body>
		<div id="app">
			<div class="container">
				<div id="topbar">
					<div class="content">
					
						<h1 id="title">BeerBot</h1>
						<span>v1.0</span>
					</div>
				</div>
			</div>
			
			<div class="container">

				<div class="content">
					<span id="angle-value"></span>
					<canvas id="angle"></canvas>

					<br>

				
					<div id="joystick">

						<span id="left-value"></span>
						<span id="right-value"></span>
							
						<span id="guide-text">Click here to control</span>

					</div>
					
				</div>

				<div class="content">

					<h3>Telemetry</h3>
					<table>
						<tr>
							<th>Angle:</th>
							<td>0 degress</td>
						</tr>

						<tr>
							<th>Voltage:</th>
							<td>0 V</td>
						</tr>

						<tr>
							<th>Weight:</th>
							<td>0.12 kg</td>
						</tr>
					</table>
				</div>
			</div>
		</div>

		<script type="text/javascript">
		
			var x = 0;	var y = 0;
			var sX = 0; var sY = 0;
			var V = 0; 	var H = 0;

			var ws = new WebSocket("ws://192.168.4.1/data");

			function calculateSpeeds(){
				// FÃ¸rste kvadrant
				if(x > 0 && y > 0){
					V = Math.sqrt(x*x + y*y);
					H = V * (y*y - x*x)/( y*y + x*x );
				}
				// Anden kvadrant
				if(x < 0 && y > 0){
					H = Math.sqrt(x*x + y*y);
					V = H * (y*y - x*x)/( y*y + x*x );
				}
				// Tredje kvadrant
				if(x < 0 && y < 0){
					V = -Math.sqrt(x*x + y*y);
					H = V * (y*y - x*x)/( y*y + x*x );
				}
				// Fjerde kvadrant
				if(x > 0 && y < 0){
				 	H = -Math.sqrt(x*x + y*y);
					V = H * (y*y - x*x)/( y*y + x*x );
				}
				if( x == 0 && y > 0){
					V = Math.sqrt(x*x + y*y)
					H = V;
				}
				if( x == 0 && y < 0){
					V = -Math.sqrt(x*x + y*y)
					H = V;
				}
				if( y == 0 && x > 0){
					V = Math.sqrt(x*x + y*y)
					H = -V;
				}
				if( y == 0 && x < 0){
					H = Math.sqrt(x*x + y*y)
					V = -H;
				}

				H = Math.round(H * 100) / 100;
				V = Math.round(V * 100) / 100;

				document.getElementById('left-value').innerHTML = V;
				document.getElementById('right-value').innerHTML = H;
			}

			setInterval(function() {

				var parked = 0;

				if(ws.readyState == 1){
					ws.send(V + ":" + H + ":" + parked);
				}

			}, 50);


			var manager = nipplejs.create({
				zone: document.getElementById('joystick'),
				catchDistance: 100,
				color: '#0070ff',
				size: 200
			});

			manager.on('added', function (event, nipple) {

				document.getElementById('guide-text').style.display = "none";
				document.getElementById('left-value').style.display = "block";
				document.getElementById('right-value').style.display = "block";

				sX = nipple.position.x;
				sY = nipple.position.y;

			}).on('removed', function (event, nipple) {

				document.getElementById('guide-text').style.display = "block";
				document.getElementById('left-value').style.display = "none";
				document.getElementById('right-value').style.display = "none";

			}).on('move', function (event, nipple) {

				x = nipple.position.x - sX;
				y = -(nipple.position.y - sY);

				calculateSpeeds();

			}).on('end', function (event, nipple) {

				H = 0;
				V = 0;

			});
			
			ws.onmessage = function (event) {
				console.log(event.data);
				gauge.set(event.data);
			};


			var opts = {
				angle: 0, // The span of the gauge arc
				lineWidth: 0.2, // The line thickness
				radiusScale: 0.8, // Relative radius

				pointer: {
					length: 0.6, // // Relative to gauge radius
					strokeWidth: 0.06, // The thickness
					color: '#3c3c3c' // Fill color
				},

				limitMax: false,     // If false, max value increases automatically if value > maxValue
				limitMin: false,     // If true, the min value of the gauge will be fixed

				highDpiSupport: true,     // High resolution support
				staticZones: [
				   {strokeStyle: "#F03E3E", min: -90, max: -60}, // Red from 100 to 130
				   {strokeStyle: "#FFDD00", min: -60, max: -30}, // Yellow
				   {strokeStyle: "#30B32D", min: -30, max: 30}, // Green
				   {strokeStyle: "#FFDD00", min: 30, max: 60}, // Yellow
				   {strokeStyle: "#F03E3E", min: 60, max: 90}  // Red
				],
			};

			var target = document.getElementById('angle');
			var gauge = new Gauge(target).setOptions(opts); 

			gauge.setTextField(document.getElementById("angle-value"));

			gauge.maxValue = 90;
			gauge.minValue = -90; 

			gauge.set(0); // set actual value



		</script>

	</body>
</html>